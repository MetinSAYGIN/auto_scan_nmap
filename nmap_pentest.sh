#!/bin/bash

# Vérification du nombre d'arguments
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <REMOTE_IP>"
  exit 1
fi
if ! [[ "$ID" =~ ^[0-9]+$ ]]; then
    ID=0  # Set ID to 0 if it's not a number
fi
highest_dir=$(find . -maxdepth 1 -type d | sort -r | head -n 1)
ID="${highest_dir:2:2}"
((ID = ID + 1))
if [ "$ID" -lt 10 ]; then
    ID="0$ID"
fi
TARGET=$1
OUTPUT_DIR=$ID"__"$TARGET
mkdir -p $OUTPUT_DIR
chmod -R 777 $OUTPUT_DIR
TEMP_FILE=$OUTPUT_DIR/"temp_open_port_"
OPEN_TCP=$OUTPUT_DIR/"open_TCP"
OPEN_UDP=$OUTPUT_DIR/"open_UDP"
echo "Début du pentest Nmap sur la cible distante : $TARGET"
echo "Les résultats seront stockés dans le répertoire : $OUTPUT_DIR"
if nmap -sn "$TARGET" | grep -q "Host is up"; then
    echo "Host accept ICMP"   # Host is reachable
    ICMP=""
else
    ICMP="-Pn"
    echo "Host doesnt accept ICMP or down"  # Host is not reachable
fi

echo "Scan rapide des ports ouverts"
nmap -p- -T4 $TARGET -oG $TEMP_FILE"_TCP" -d --max-retries 1 $ICMP
(grep "Ports" $TEMP_FILE"_TCP" | grep -o '[0-9]\+/open/tcp//' | sed 's#/open/tcp//##')  > $OPEN_TCP
mv $OPEN_TCP $OPEN_TCP"TEMP"
sed -e 's/ //g' -e 's/\([0-9]\+\)/\1,/g' $OPEN_TCP"TEMP" | tr -d '\n' > $OPEN_TCP
rm $OPEN_TCP"TEMP"
if [[ ! -s "$OPEN_TCP" ]]; then
    echo "The TCP file is empty or does not exist. Stopping the program."
    exit 1  # Exit the script with a non-zero status
fi

# Vérifier si le fichier contient 445 ou 139 en une seule commande
if grep -qE '(^|[^0-9])(445|139)($|[^0-9])' "$OPEN_TCP"; then
    # Exécuter nmap sur les ports trouvés 445 et 139
    echo "Ports 445 ou 139 trouvés dans le fichier."
    # Remplacez TARGET_IP par l'adresse IP cible
    nmap -p 445,139 --script smb-enum-shares,smb-enum-users,smb-vuln* $TARGET -oN $OUTPUT_DIR/scan_SMB.txt
else
    echo "Aucun port 445 ou 139 trouvé dans le fichier."
fi

echo "Scan approfondie des ports qui sont ouverts"
nmap -p $(cat "$OPEN_TCP") $ICMP -sS -sV --script vuln -oN $OUTPUT_DIR/TCP_scan.txt $TARGET -O 

nmap $ICMP -sU -p- --min-rate=1000 --max-retries=1 --open -v $TARGET -d -oG $TEMP_FILE"_UDP"
(grep "Ports" $TEMP_FILE"_UDP" | grep -o '[0-9]\+/open/udp//' | sed 's#/open/udp//##')  > $OPEN_UDP
mv $OPEN_UDP $OPEN_UDP"TEMP"
sed -e 's/ //g' -e 's/\([0-9]\+\)/\1,/g' $OPEN_UDP"TEMP" | tr -d '\n' > $OPEN_UDP
rm $OPEN_UDP"TEMP"
if [[ ! -s "$OPEN_UDP" ]]; then
    echo "The UDP file is empty or does not exist. Stopping the program."
    exit 1  # Exit the script with a non-zero status
fi
nmap -p $(cat "$OPEN_UDP") $ICMP -sS -sV --script vuln -oN $OUTPUT_DIR/UDP_scan.txt $TARGET -O 
